name: Build package aapt

on:
  push:
    paths:
      - '.github/**'
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Reason'     
        required: false
        default: 'update package'
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_HOME: "/opt/termux/android-sdk"
      NDK: "/opt/termux/android-ndk"

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Clone termux-packages repository
        uses: actions/checkout@v3
        with:
          repository: termux/termux-packages
          path: termux-packages

      - name: Apply termux patches
        run: |
          cd termux-packages
          git apply ../termux/*.patch

      - name: Clone AOSP base repository
        uses: actions/checkout@v3
        with:
          repository: termux/termux-packages
          path: termux-packages/packages/aapt/base
          ref: android-12.0.0_r27
          fetch-depth: 1

      - name: Add aapt2 patches
        run: cp *.patch termux-packages/packages/aapt

      - name: Build aapt package
        run: ./build.sh

      - name: Prepare artifacts
        run: ./prepare.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: aapt2-${{ github.sha }}
          path: termux-packages/output/*/data/data/com.termux/files/usr/bin/*
          if-no-files-found: error
